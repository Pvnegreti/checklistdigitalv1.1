<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Administrador - Gestão Avançada</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #fff8e1;
    margin: 0; padding: 20px;
  }
  header {
    background: linear-gradient(90deg, #f57c00, #ffca28);
    color: white;
    padding: 15px;
    text-align: center;
    font-size: 1.8em;
    font-weight: bold;
    margin-bottom: 20px;
  }
  section {
    max-width: 1000px;
    margin: 0 auto 40px auto;
    background: #fff3e0;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  h2 {
    color: #f57c00;
    margin-top: 0;
  }
  input[type="text"], input[type="number"] {
    padding: 6px 8px;
    margin-bottom: 10px;
    width: 100%;
    max-width: 300px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  th, td {
    border: 1px solid #f57c00;
    padding: 8px;
    text-align: left;
    font-size: 0.9em;
  }
  th {
    background-color: #f57c00;
    color: white;
  }
  button {
    background-color: #f57c00;
    border: none;
    color: white;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    padding: 6px 12px;
    margin: 2px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #ef6c00;
  }
  .actions {
    text-align: center;
    margin-top: 30px;
  }
  #logoutBtn {
    background: #ff6f00;
    padding: 12px 24px;
    font-size: 1em;
  }
  .message {
    text-align: center;
    font-weight: 600;
    margin: 10px 0;
    color: #b71c1c;
  }
  canvas {
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-top: 10px;
  }
  .backup-section {
    margin-top: 20px;
    text-align: center;
  }
  #btnGerarRelatorio {
    background-color: #1976d2;
    margin-top: 20px;
    padding: 10px 20px;
  }
  #btnGerarRelatorio:hover {
    background-color: #155a9c;
  }
</style>

<!-- jsPDF e AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<!-- SheetJS para Excel -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<header>FALBOM NUTRIÇÃO ANIMAL - Administrador Avançado</header>

<section>
  <h2>Usuários Cadastrados</h2>
  <input type="text" id="filtroUsuarios" placeholder="Filtrar usuários..." />
  <button id="exportarUsuariosBtn">Exportar Usuários para Excel</button>
  <div id="usuariosMessage" class="message" style="display:none;"></div>
  <table id="usuariosTable">
    <thead>
      <tr>
        <th>Usuário</th>
        <th>Senha</th>
        <th>Nível</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h2>Checklists Realizados</h2>
  <input type="text" id="filtroChecklists" placeholder="Filtrar checklists..." />
  <div id="checklistsMessage" class="message" style="display:none;"></div>
  <table id="checklistsTable" style="margin-bottom: 10px;">
    <thead>
      <tr>
        <th>Usuário</th>
        <th>Nível</th>
        <th>Data/Hora Início</th>
        <th>Data/Hora Fim</th>
        <th>Data/Hora Envio</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h2>Editor de Checklist</h2>
  <label for="nomeChecklistInput">Nome do Check List:</label>
  <input type="text" id="nomeChecklistInput" placeholder="Ex: Check List Operacional" style="width: 300px; margin-bottom: 10px;" />

  <div>
    <h3>Campos do Check List</h3>
    <div id="fieldList" style="max-height:300px; overflow-y:auto; border:1px solid #f57c00; padding:10px; border-radius:6px; background:#fff8dc;"></div>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <input type="text" id="novoCampoInput" placeholder="Nome do novo campo" style="flex:1;" />
      <button id="addCampoBtn">Adicionar Campo</button>
    </div>
  </div>

  <button id="salvarChecklistBtn" style="margin-top: 10px;">Salvar Alterações</button>
  <button id="gerarExcelBtn" style="margin-top: 10px;">Gerar e Baixar Excel</button>
  <button id="downloadChecklistBrancoBtn" style="margin-top: 10px;">Download Checklist em Branco (PDF)</button>
</section>

<section>
  <h2>Dashboard</h2>
  <canvas id="graficoChecklists" width="900" height="300"></canvas>
</section>

<section class="backup-section">
  <h2>Backup e Restauração</h2>
  <button id="backupBtn">Fazer Backup dos Dados</button>
  <input type="file" id="restoreInput" accept="application/json" />
  <button id="restoreBtn">Restaurar Dados do Backup</button>
</section>

<div class="actions">
  <button id="btnGerarRelatorio">Gerar Relatório Completo</button>
  <button id="logoutBtn">Sair / Voltar ao Login</button>
</div>

<script>
  const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
  if(!usuarioLogado || usuarioLogado.nivel !== 'Administrador') {
    alert('Acesso negado. Você deve estar logado como Administrador para acessar esta página.');
    window.location.href = 'index.html';
  }

  const usuariosTableBody = document.querySelector('#usuariosTable tbody');
  const checklistsTableBody = document.querySelector('#checklistsTable tbody');
  const usuariosMessage = document.getElementById('usuariosMessage');
  const checklistsMessage = document.getElementById('checklistsMessage');
  const nomeChecklistInput = document.getElementById('nomeChecklistInput');
  const fieldList = document.getElementById('fieldList');
  const novoCampoInput = document.getElementById('novoCampoInput');
  const addCampoBtn = document.getElementById('addCampoBtn');
  const salvarChecklistBtn = document.getElementById('salvarChecklistBtn');
  const gerarExcelBtn = document.getElementById('gerarExcelBtn');
  const downloadChecklistBrancoBtn = document.getElementById('downloadChecklistBrancoBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const filtroUsuarios = document.getElementById('filtroUsuarios');
  const filtroChecklists = document.getElementById('filtroChecklists');
  const exportarUsuariosBtn = document.getElementById('exportarUsuariosBtn');
  const backupBtn = document.getElementById('backupBtn');
  const restoreInput = document.getElementById('restoreInput');
  const restoreBtn = document.getElementById('restoreBtn');
  const btnGerarRelatorio = document.getElementById('btnGerarRelatorio');
  const ctxGrafico = document.getElementById('graficoChecklists').getContext('2d');

  let camposChecklist = [
    'Hora',
    'T Set Point (°C)',
    'Temperatura 1° Efeito (°C)',
    'Temperatura 2° Efeito (°C)',
    'Vazão Real (L/h)',
    'Vácuo (mmCA)',
    'Pressão vapor (kgf/cm²)',
    'Água termocompressor (°C)',
    'Condutividade (μS/cm)',
    'Torre de Resfriamento Entrada (°C)',
    'Torre de Resfriamento Saida (°C)',
    'Umidade',
    'Matéria seca',
    '%Brix',
    'Quantidade de liquido de entrada (kg)',
    'Quantidade de liquido de saida (kg)',
    'Densidade (g/L)'
  ];

  // Funções auxiliares para formatar datas
  function formatarDataISO(isoStr) {
    if(!isoStr) return '';
    const d = new Date(isoStr);
    return d.toLocaleDateString('pt-BR');
  }
  function formatarDataHoraISO(isoStr) {
    if(!isoStr) return '';
    const d = new Date(isoStr);
    return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR');
  }

  // Função para registrar logs
  function registrarLog(mensagem) {
    const logs = JSON.parse(localStorage.getItem('logsAuditoria')) || [];
    logs.push({mensagem, usuario: usuarioLogado.username, data: new Date().toISOString()});
    localStorage.setItem('logsAuditoria', JSON.stringify(logs));
  }

  // Função para registrar download
  function registrarDownload(usuario) {
    const logsDownload = JSON.parse(localStorage.getItem('logsDownload')) || [];
    logsDownload.push({ usuario, data: new Date().toISOString() });
    localStorage.setItem('logsDownload', JSON.stringify(logsDownload));
  }

  // --- Usuários ---

  function carregarUsuarios(filtro = '') {
    usuariosTableBody.innerHTML = '';
    let temUsuarios = false;
    const filtroLower = filtro.toLowerCase();
    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith('user_')) {
        const user = JSON.parse(localStorage.getItem(key));
        if(user.username === 'admin') continue;
        if(!user.username.toLowerCase().includes(filtroLower) && !user.nivel.toLowerCase().includes(filtroLower)) continue;
        temUsuarios = true;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${user.username}</td>
          <td><input type="text" value="${user.password}" data-username="${user.username}" class="senhaInput" /></td>
          <td>${user.nivel}</td>
          <td>
            <button data-username="${user.username}" class="salvarSenhaBtn">Salvar</button>
            <button data-username="${user.username}" class="excluirUsuarioBtn" style="background:#d84315; margin-left:5px;">Excluir</button>
            <button data-username="${user.username}" class="resetSenhaBtn" style="background:#1976d2; margin-left:5px;">Redefinir Senha</button>
          </td>
        `;
        usuariosTableBody.appendChild(tr);
      }
    }
    usuariosMessage.style.display = temUsuarios ? 'none' : 'block';
    usuariosMessage.textContent = temUsuarios ? '' : 'Nenhum usuário cadastrado (exceto admin).';

    // Eventos para salvar senha, excluir usuário e redefinir senha
    document.querySelectorAll('.salvarSenhaBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const username = btn.getAttribute('data-username');
        const inputSenha = document.querySelector(`input.senhaInput[data-username="${username}"]`);
        const novaSenha = inputSenha.value.trim();
        if(novaSenha === '') {
          alert('A senha não pode ser vazia.');
          return;
        }
        const userKey = 'user_' + username;
        const user = JSON.parse(localStorage.getItem(userKey));
        user.password = novaSenha;
        localStorage.setItem(userKey, JSON.stringify(user));
        alert(`Senha do usuário "${username}" atualizada com sucesso.`);
        registrarLog(`Senha do usuário "${username}" alterada.`);
      });
    });

    document.querySelectorAll('.excluirUsuarioBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const username = btn.getAttribute('data-username');
        if(confirm(`Tem certeza que deseja excluir o usuário "${username}"?`)) {
          localStorage.removeItem('user_' + username);
          carregarUsuarios(filtroUsuarios.value);
          registrarLog(`Usuário "${username}" excluído.`);
        }
      });
    });

    document.querySelectorAll('.resetSenhaBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const username = btn.getAttribute('data-username');
        const novaSenha = prompt(`Digite a nova senha para o usuário "${username}":`);
        if(novaSenha === null) return; // Cancelou
        if(novaSenha.trim() === '') {
          alert('Senha não pode ser vazia.');
          return;
        }
        const userKey = 'user_' + username;
        const user = JSON.parse(localStorage.getItem(userKey));
        user.password = novaSenha.trim();
        localStorage.setItem(userKey, JSON.stringify(user));
        carregarUsuarios(filtroUsuarios.value);
        alert(`Senha do usuário "${username}" redefinida com sucesso.`);
        registrarLog(`Senha do usuário "${username}" redefinida para "${novaSenha.trim()}".`);
      });
    });
  }

  filtroUsuarios.addEventListener('input', () => {
    carregarUsuarios(filtroUsuarios.value);
  });

  exportarUsuariosBtn.addEventListener('click', () => {
    const usuarios = [];
    const usuarioSolicitante = usuarioLogado.username;
    const hoje = new Date().toISOString().slice(0,10);

    registrarDownload(usuarioSolicitante);

    function getAcessosUsuario(username) {
      const logsLogin = JSON.parse(localStorage.getItem('logsLogin')) || [];
      return logsLogin.filter(log => log.usuario === username).map(log => log.data);
    }

    function getChecklistsUsuario(username) {
      const checklists = JSON.parse(localStorage.getItem('checklistsSalvos')) || [];
      return checklists.filter(cl => cl.usuario === username);
    }

    function getErrosUsuario(username) {
      const logsErro = JSON.parse(localStorage.getItem('logsErro')) || [];
      return logsErro.filter(log => log.usuario === username);
    }

    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith('user_')) {
        const user = JSON.parse(localStorage.getItem(key));
        if(user.username === 'admin') continue;

        const acessos = getAcessosUsuario(user.username);
        const checklists = getChecklistsUsuario(user.username);
        const erros = getErrosUsuario(user.username);

        usuarios.push([
          user.username,
          user.nivel,
          formatarDataISO(user.dataCriacao),
          acessos.length,
          acessos.map(a => formatarDataHoraISO(a)).join('; '),
          checklists.length,
          checklists.map(c => formatarDataHoraISO(c.dtEnvio)).join('; '),
          erros.length > 0 ? erros.map(e => formatarDataHoraISO(e.data) + ': ' + e.mensagem).join('; ') : 'Nenhum'
        ]);
      }
    }

    if(usuarios.length === 0) {
      alert('Nenhum usuário para exportar.');
      return;
    }

    const cabecalho = [
      'Usuário',
      'Nível',
      'Data de Criação',
      'Qtd. Acessos',
      'Datas de Acesso',
      'Qtd. Checklists',
      'Datas Checklists',
      'Erros / Instabilidades'
    ];

    const linhas = [cabecalho, ...usuarios];

    const ws = XLSX.utils.aoa_to_sheet(linhas);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Usuários');

    XLSX.writeFile(wb, `usuarios_exportados_${hoje}.xlsx`);
  });

  // --- Editor de Checklist ---

  function atualizarListaCampos() {
    fieldList.innerHTML = '';
    camposChecklist.forEach((campo, i) => {
      const div = document.createElement('div');
      div.className = 'field-item';
      div.innerHTML = `
        <span>${campo}</span>
        <button data-index="${i}">Excluir</button>
      `;
      fieldList.appendChild(div);
    });

    fieldList.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = parseInt(btn.getAttribute('data-index'));
        if(confirm(`Deseja remover o campo "${camposChecklist[idx]}"?`)) {
          camposChecklist.splice(idx, 1);
          atualizarListaCampos();
        }
      });
    });
  }

  addCampoBtn.addEventListener('click', () => {
    const novoCampo = novoCampoInput.value.trim();
    if(novoCampo === '') return alert('Digite o nome do novo campo.');
    if(camposChecklist.includes(novoCampo)) return alert('Campo já existe.');
    camposChecklist.push(novoCampo);
    novoCampoInput.value = '';
    atualizarListaCampos();
  });

  salvarChecklistBtn.addEventListener('click', () => {
    if(checklistEditandoIndex === null || !checklistEditandoDados) {
      alert('Selecione um checklist para editar.');
      return;
    }
    checklistEditandoDados.nomeChecklist = nomeChecklistInput.value.trim() || 'Check List Operacional';

    camposChecklist.forEach(campo => {
      const key = campoParaKey(campo);
      if(!(key in checklistEditandoDados)) {
        checklistEditandoDados[key] = '';
      }
    });

    Object.keys(checklistEditandoDados).forEach(key => {
      if(!['usuario','nivelUsuario','dtInicio','dtFim','dtEnvio','nomeChecklist'].includes(key)) {
        const campoFormatado = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        if(!camposChecklist.includes(campoFormatado)) {
          delete checklistEditandoDados[key];
        }
      }
    });

    let checklists = JSON.parse(localStorage.getItem('checklistsSalvos')) || [];
    checklists[checklistEditandoIndex] = checklistEditandoDados;
    localStorage.setItem('checklistsSalvos', JSON.stringify(checklists));

    alert('Checklist salvo com sucesso!');
    carregarChecklists(filtroChecklists.value);
    registrarLog(`Checklist alterado.`);
  });

  gerarExcelBtn.addEventListener('click', () => {
    if(!checklistEditandoDados) return alert('Selecione um checklist para editar.');

    const nomeArquivo = nomeChecklistInput.value.trim() || 'checklist';

    const linhasExcel = [];

    const cabecalho = [
      'Data/Hora Início',
      'Data/Hora Fim',
      'Data/Hora Envio',
      'Nível Usuário',
      'Usuário'
    ].concat(camposChecklist);
    linhasExcel.push(cabecalho);

    const linha = [
      checklistEditandoDados.dtInicio,
      checklistEditandoDados.dtFim,
      checklistEditandoDados.dtEnvio,
      checklistEditandoDados.nivelUsuario,
      checklistEditandoDados.usuario
    ];

    camposChecklist.forEach(campo => {
      const key = campoParaKey(campo);
      linha.push(checklistEditandoDados[key] || '');
    });
    linhasExcel.push(linha);

    const linhaMedia = [
      'Média',
      '',
      '',
      '',
      ''
    ];
    camposChecklist.forEach(campo => {
      const key = campoParaKey(campo);
      const val = parseFloat(checklistEditandoDados[key]);
      linhaMedia.push(!isNaN(val) ? val.toFixed(3) : '');
    });
    linhasExcel.push(linhaMedia);

    const ws = XLSX.utils.aoa_to_sheet(linhasExcel);
    ws['!cols'] = Array(cabecalho.length).fill({wch: 20});

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Checklist');

    const dataHoraAgora = new Date().toISOString().replace(/[:.]/g,'-');
    const nomeArquivoFinal = `${nomeArquivo}_${dataHoraAgora}.xlsx`;

    XLSX.writeFile(wb, nomeArquivoFinal);
    registrarLog(`Checklist exportado para Excel.`);
    alert('Arquivo Excel gerado e baixado com sucesso!');
  });

  // --- Download Checklist em Branco (PDF) ---

  downloadChecklistBrancoBtn.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const pageWidth = doc.internal.pageSize.getWidth();
    const marginLeft = 14;
    let y = 20;

    // Cabeçalho
    doc.setFontSize(16);
    doc.setTextColor(245, 124, 0);
    doc.text('FALBOM NUTRIÇÃO ANIMAL', pageWidth / 2, y, { align: 'center' });
    y += 12;

    // Título do checklist
    const nomeChecklist = nomeChecklistInput.value.trim() || 'Check List Operacional';
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(nomeChecklist, pageWidth / 2, y, { align: 'center' });
    y += 15;

    // Informação para preenchimento manual
    doc.setFontSize(11);
    doc.text('Preencha os campos abaixo manualmente:', marginLeft, y);
    y += 10;

    // Desenhar linhas para preenchimento
    const lineHeight = 8;
    const lineWidth = pageWidth - marginLeft * 2;

    camposChecklist.forEach(campo => {
      if(y + lineHeight > doc.internal.pageSize.getHeight() - 20) {
        doc.addPage();
        y = 20;
        // Reescreve cabeçalho em nova página
        doc.setFontSize(16);
        doc.setTextColor(245, 124, 0);
        doc.text('FALBOM NUTRIÇÃO ANIMAL', pageWidth / 2, y, { align: 'center' });
        y += 15;
      }
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(campo, marginLeft, y);
      y += 3;
      doc.line(marginLeft, y, marginLeft + lineWidth, y); // linha para preenchimento
      y += lineHeight;
    });

    doc.save(`checklist_em_branco_${new Date().toISOString().slice(0,10)}.pdf`);
  });

  // --- Dashboard ---

  function gerarDashboard() {
    const checklists = JSON.parse(localStorage.getItem('checklistsSalvos')) || [];
    const contagemPorUsuario = {};

    checklists.forEach(cl => {
      contagemPorUsuario[cl.usuario] = (contagemPorUsuario[cl.usuario] || 0) + 1;
    });

    const labelsUsuarios = Object.keys(contagemPorUsuario);
    const dadosUsuarios = labelsUsuarios.map(u => contagemPorUsuario[u]);

    if(graficoChecklists) graficoChecklists.destroy();

    graficoChecklists = new Chart(ctxGrafico, {
      type: 'bar',
      data: {
        labels: labelsUsuarios,
        datasets: [{
          label: 'Quantidade de Checklists por Usuário',
          data: dadosUsuarios,
          backgroundColor: 'rgba(245, 124, 0, 0.7)'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {display: true},
          title: {display: true, text: 'Checklists por Usuário'}
        }
      }
    });
  }

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('usuarioLogado');
    window.location.href = 'index.html';
  });

  // --- Relatório PDF ---

  btnGerarRelatorio.addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const usuario = usuarioLogado.username;
    const hoje = new Date();
    const dataFormatada = hoje.toISOString().slice(0,10);

    const pageWidth = doc.internal.pageSize.getWidth();

    // Cabeçalho fixo em todas as páginas
    doc.setFontSize(16);
    doc.setTextColor(245, 124, 0);
    doc.text('FALBOM NUTRIÇÃO ANIMAL', pageWidth / 2, 15, { align: 'center' });

    // Ajusta o início do conteúdo para não sobrepor o cabeçalho
    let y = 30;

    doc.setFontSize(18);
    doc.setTextColor(0, 0, 0);
    doc.text('Relatório Completo do Sistema', 14, y);
    y += 8;
    doc.setFontSize(11);
    doc.text(`Usuário: ${usuario}`, 14, y);
    y += 6;
    doc.text(`Data de geração: ${dataFormatada}`, 14, y);
    y += 6;
    doc.text('Período: Últimos 30 dias', 14, y);
    y += 10;

    function filtrarLogsUltimos30Dias(logs) {
      const trintaDiasAtras = new Date();
      trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 30);
      return logs.filter(log => {
        const dataLog = new Date(log.data);
        return dataLog >= trintaDiasAtras && dataLog <= hoje;
      });
    }

    const logs = JSON.parse(localStorage.getItem('logsAuditoria')) || [];
    const logsRecentes = filtrarLogsUltimos30Dias(logs);

    if(logsRecentes.length === 0) {
      doc.text('Não há registros de alterações nos últimos 30 dias.', 14, y);
      y += 10;
    } else {
      const tabelaLogs = logsRecentes.map(log => [
        new Date(log.data).toLocaleString('pt-BR'),
        log.usuario,
        log.mensagem
      ]);

      doc.autoTable({
        head: [['Data/Hora', 'Usuário', 'Descrição da Alteração']],
        body: tabelaLogs,
        startY: y,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [245, 124, 0] },
        margin: { left: 14, right: 14 },
        columnStyles: {
          0: { cellWidth: 40 },
          1: { cellWidth: 30 },
          2: { cellWidth: 110 }
        },
        didDrawPage: (data) => {
          doc.setFontSize(16);
          doc.setTextColor(245, 124, 0);
          doc.text('FALBOM NUTRIÇÃO ANIMAL', pageWidth / 2, 15, { align: 'center' });
        }
      });
      y = doc.lastAutoTable.finalY + 10;
    }

    const logins = JSON.parse(localStorage.getItem('logsLogin')) || [];
    const loginsRecentes = logins.filter(login => {
      const dataLogin = new Date(login.data);
      const trintaDiasAtras = new Date();
      trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 30);
      return dataLogin >= trintaDiasAtras && dataLogin <= hoje;
    });

    if(loginsRecentes.length === 0) {
      doc.text('Não há registros de login nos últimos 30 dias.', 14, y);
      y += 10;
    } else {
      const tabelaLogins = loginsRecentes.map(login => [
        new Date(login.data).toLocaleString('pt-BR'),
        login.usuario,
        login.acao || 'Login'
      ]);

      doc.autoTable({
        head: [['Data/Hora', 'Usuário', 'Ação']],
        body: tabelaLogins,
        startY: y,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [245, 124, 0] },
        margin: { left: 14, right: 14 },
        columnStyles: {
          0: { cellWidth: 40 },
          1: { cellWidth: 30 },
          2: { cellWidth: 110 }
        },
        didDrawPage: (data) => {
          doc.setFontSize(16);
          doc.setTextColor(245, 124, 0);
          doc.text('FALBOM NUTRIÇÃO ANIMAL', pageWidth / 2, 15, { align: 'center' });
        }
      });
      y = doc.lastAutoTable.finalY + 10;
    }

    let totalUsuarios = 0;
    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith('user_')) {
        const user = JSON.parse(localStorage.getItem(key));
        if(user.username !== 'admin') totalUsuarios++;
      }
    }
    doc.text(`Total de usuários cadastrados (exceto admin): ${totalUsuarios}`, 14, y);
    y += 10;

    const checklists = JSON.parse(localStorage.getItem('checklistsSalvos')) || [];
    doc.text(`Total de checklists salvos: ${checklists.length}`, 14, y);
    y += 10;

    const checklistsPorUsuario = {};
    checklists.forEach(cl => {
      checklistsPorUsuario[cl.usuario] = (checklistsPorUsuario[cl.usuario] || 0) + 1;
    });

    const statsData = Object.entries(checklistsPorUsuario).map(([usuario, qtd]) => [usuario, qtd]);

    if(statsData.length > 0) {
      doc.autoTable({
        head: [['Usuário', 'Quantidade de Checklists']],
        body: statsData,
        startY: y,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [245, 124, 0] },
        margin: { left: 14, right: 14 },
        columnStyles: {
          0: { cellWidth: 80 },
          1: { cellWidth: 40 }
        },
        didDrawPage: (data) => {
          doc.setFontSize(16);
          doc.setTextColor(245, 124, 0);
          doc.text('FALBOM NUTRIÇÃO ANIMAL', pageWidth / 2, 15, { align: 'center' });
        }
      });
    }

    const nomeArquivo = `relatorio_${dataFormatada}_${usuario}.pdf`;
    doc.save(nomeArquivo);
  });

  // Inicializar tudo
  carregarUsuarios();
  carregarChecklists();
  atualizarListaCampos();
  gerarDashboard();
</script>

</body>
</html>
